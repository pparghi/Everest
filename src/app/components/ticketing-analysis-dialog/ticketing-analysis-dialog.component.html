<mat-drawer-container class="full-screen-drawer-container" [hasBackdrop]="true">
    <mat-drawer #drawer [mode]="'over'" positionBottom="bottom">
        <!-- Drawer content -->
        <div class="bottom-drawer-content">
            <div class="drawer-header">
                <h4>DUNS Search Results</h4>
                <button mat-raised-button color="primary" (click)="searchDunsByNameOnly()" style="margin-left: 16px;">
                    <mat-icon>search</mat-icon> Search By Name Only
                </button>
                <button mat-icon-button (click)="drawer.close()" style="margin-left: auto;">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
            <p><b>Company: </b>{{debtorName}}&nbsp;&nbsp;&nbsp;&nbsp;<b>Address: </b>{{debtorFullAddress}}</p>
            <mat-divider></mat-divider>
            <!-- Loading indicator -->
            <div *ngIf="loadingDuns" class="loading-spinner">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Searching for debtor matches...</p>
            </div>
            <!-- Results area with cards -->
            <div *ngIf="!loadingDuns" class="duns-results">
                <h5 *ngIf="dunsMatches.length > 0">Matching Companies ({{dunsMatches.length}})</h5>
                <p *ngIf="dunsMatches.length === 0">No matches found. Please try search by name only.</p>
                
                <div class="duns-cards-container">
                    <app-duns-card *ngFor="let match of dunsMatches" [dunsInfo]="match" (selectDunsCompany)="updateDebtorWithDunsInfo(match)"></app-duns-card>
                </div>
            </div>
            <!-- <div class="drawer-info">
            </div> -->
        </div>
    </mat-drawer>

    <div class="analysis-container">


        <!-- ##################### new layout ##################### -->
        <!-- credit request # card -->
        <mat-card appearance="raised" class="card-container-v2">
            <div class="card-base">
                <p class="text2">Credit Request #</p>
                <p class="title2 word-wrap">{{ticketData.RequestNo}} on {{ticketData.RequestDate | date:'MM/dd/yyyy h:mm a'}} by {{ticketData.RequestUser}}</p>
                
                <div class="debtor-client-row">
                    <div class="debtor-section">
                        <p class="text2">Debtor Name</p>
                        <p class="title2 word-wrap">{{ticketData.Debtor}}</p>
                    </div>
                    
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    
                    <div class="client-section">
                        <p class="text2">Client Name</p>
                        <p class="title2 word-wrap">{{ticketData.Client}}</p>
                    </div>
                </div>
            </div>
        </mat-card>

        <!-- debtor profiles card -->
        <mat-card appearance="raised" class="card-container-v2">
            <div class="card-base">
                <p class="title2">Debtor Profile</p>
                <div class="flex-row">
                    <div class="flex-column" style="flex: 3; margin-right: 34px;">
                        <div style="display: flex; align-items: center; gap: 8px; ">
                            <p [matBadge]="switchedDebtorType==='N/A' ? originalDebtorType : switchedDebtorType" matBadgeOverlap="false" class="text2" style="width:75px; margin-right: 80px;">Debtor Name</p>
                            @if (originalDebtorType !== 'Non-Grouped') {
                                <p [matMenuTriggerFor]="menu" class="switch-debtor-p-button">Switch Debtor</p>
                                <mat-menu #menu="matMenu" class="switch-debtor-menu">
                                    @for (it of switchableDebtors; track it.DebtorKey) {
                                        <button mat-menu-item (click)="onSwitchDebtorClick(it.DebtorKey)" 
                                        [disabled]="(it.DebtorKey === switchedDebtorKey) || (!switchedDebtorKey && it.DebtorKey === originalDebtorKey)"
                                        [matTooltip]="getDebtorTooltipText(it)" matTooltipPosition="right" matTooltipClass="custom-tooltip" [matTooltipShowDelay]="500"
                                        [ngClass]="it.isMaster ? 'master-debtor-item' : 'member-debtor-item'">
                                            <div>
                                                <p class="title2 word-wrap">{{it.DebtorName}}</p>
                                                <div style="display: flex; gap: 16px; align-items: center;">
                                                    <span [ngClass]="it.isMaster ? 'master-badge' : 'member-badge'">
                                                        {{it.isMaster ? 'Master' : 'Member'}}
                                                    </span>
                                                    <p class="text2 word-wrap">Debtor ID: {{it.DebtorKey}}</p>
                                                    <p class="text2 word-wrap">Total AR: {{formatCurrency(it.TotalAR)}}</p>
                                                </div>
                                            </div>
                                        </button>
                                    }
                                </mat-menu>
                            }
                            @if (originalDebtorType !== 'Non-Grouped' && switchedDebtorKey && switchedDebtorKey !== originalDebtorKey){
                                <p class="switch-debtor-p-button" (click)="onResetSwitchDebtor()">Reset</p>
                            }
                        </div>
                        <p class="title1 word-wrap">{{debtorDetails?.Debtor}}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Established date</p>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <p class="title1 word-wrap">{{debtorDetails?.DateCreated | date:'yyyy-MM-dd'}}</p>
                            <p class="text1">{{calculateGapDays(debtorDetails?.DateCreated)}}</p>
                        </div>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-column">
                        <p class="text2">Debtor ID</p>
                        <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.DebtorKey) || 'N/A'">
                            {{debtorDetails?.DebtorKey || 'N/A'}}
                        </p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column">
                        <p class="text2">MC#</p>
                        <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.MotorCarrNo) || 'N/A'">
                            {{debtorDetails?.MotorCarrNo || 'N/A'}}
                        </p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column">
                        <p class="text2">DUNS</p>
                        <div style="display: flex; gap: 16px;">
                            <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.DbDunsNo) || 'N/A'">
                                {{debtorDetails?.DbDunsNo || 'N/A'}}
                            </p>
                            <mat-icon color="primary" (click)="searchDuns(debtorDetails)" class="input-icon ms-2 icon-hover-effect">find_replace</mat-icon>
                        </div>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column">
                        <p class="text2"># of Client Relationship</p>
                        <p class="title1" [ngClass]="textColorByValueAndType(''+numOfRelationshipClients)">
                            {{numOfRelationshipClients}}
                        </p>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-column" style="flex: 6; margin-right: 18px;">
                        <p class="text2">Address</p>
                        <p class="text2">{{ formatAddress([debtorDetails?.Addr1, debtorDetails?.City, debtorDetails?.State, debtorDetails?.Country, debtorDetails?.ZipCode]) }}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 1.5;">
                        <p class="text2">Phone1</p>
                        <p class="text2">{{debtorDetails?.Phone1 || ''}}</p>
                    </div>
                    <div class="flex-column" style="flex: 1.5;">
                        <p class="text2">Phone2</p>
                        <p class="text2">{{debtorDetails?.Phone2 || ''}}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Edit</p>
                        <mat-icon color="primary" (click)="editDebtor(debtorDetails)" class="input-icon ms-2 icon-hover-effect">edit</mat-icon>
                    </div>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Documents</p>
                        <i class="fa fa-file ms-2 icon-hover-effect primary-color" style="font-size: 20px;" (click)="openDocumentsDialog(debtorDetails?.DebtorKey)"></i>
                    </div>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Audit</p>
                        <i class="fa fa-list-check ms-2 icon-hover-effect primary-color" style="font-size: 20px;" (click)="openDebtorAuditDialog(debtorDetails?.DebtorKey)"></i>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-column" style="flex: 6; margin-right: 18px;">
                        <p class="text2">Alternate Address</p>
                        <div style="display: flex;">
                            <p class="text2 notes-truncated" 
                                [matTooltip]="formatAlternateAddress() || ''" 
                                [matTooltipDisabled]="alternateAddresses.length === 0"
                                matTooltipPosition="below"
                                matTooltipClass="custom-tooltip"
                                style="white-space: pre-line; width: 420px">
                                {{formatAlternateAddress() || ''}}
                            </p>
                            <i class="fa fa-minus-circle ms-2 icon-hover-effect-warning warning" (click)="deleteAlternateAddress()"></i>
                            <i class="fa fa-plus-circle ms-2 icon-hover-effect primary-color" (click)="addAlternateAddress()"></i>
                        </div>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 3;">
                        <p class="text2">Email</p>
                        <p class="text2 notes-truncated" 
                            [matTooltip]="debtorDetails?.Email || ''" 
                            [matTooltipDisabled]="!debtorDetails?.Email"
                            matTooltipPosition="below"
                            matTooltipClass="custom-tooltip">
                            {{formatEmail(debtorDetails?.Email)}}
                        </p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 3;">
                        <p class="text2">No Buy Code</p>
                        <mat-select id="DisputeCode" [(ngModel)]="selectedNoBuyKey" (selectionChange)="onNoBuyCodeChange($event)">
                            @if (selectedNoBuyKey === '-1') {
                            <mat-option value='-1' disabled>{{ debtorDetails?.NoBuyCode }}</mat-option>
                            }
                            <mat-option value=''>{{"Clear No Buy Code"}}</mat-option>
                            @for (noBuyCode of noBuyCodeList; track noBuyCode.DisputeCodeKey) {
                            <mat-option value={{noBuyCode.DisputeCodeKey}}>{{noBuyCode.DisputeCode}}</mat-option>
                            }
                        </mat-select>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Warning</p>
                        <p class="text2 notes-truncated" 
                            [matTooltip]="debtorDetails?.Warning || ''" 
                            [matTooltipDisabled]="!debtorDetails?.Warning"
                            matTooltipPosition="below"
                            matTooltipClass="custom-tooltip">
                            {{debtorDetails?.Warning || ''}}
                        </p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Credit Information</p>
                        <p class="text2 notes-truncated" 
                            [matTooltip]="debtorDetails?.CredNote || ''" 
                            [matTooltipDisabled]="!debtorDetails?.CredNote"
                            matTooltipPosition="below"
                            matTooltipClass="custom-tooltip">
                            {{debtorDetails?.CredNote || ''}}
                        </p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 2;">
                        <p class="text2">Instruction</p>
                        <p class="text2 notes-truncated" 
                            [matTooltip]="debtorDetails?.Notes || ''" 
                            [matTooltipDisabled]="!debtorDetails?.Notes"
                            matTooltipPosition="below"
                            matTooltipClass="custom-tooltip">
                            {{debtorDetails?.Notes || ''}}
                        </p>
                    </div>
                    <mat-divider vertical class="vertical-divider" style="visibility: hidden"></mat-divider>
                </div>
            </div>
        </mat-card>

        <div class="equal-height-row">
            <!-- Credit profiles card -->
            <div class="equal-height-column" style="flex: 7;">
                <mat-card appearance="raised" class="card-container-v2">
                    <div class="card-base">
                        <p class="title2">Credit Profile</p>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Overall credit limit</p>
                                <p class="title1">{{formatCurrency(debtorDetails?.TotalCreditLimit)}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Credit utilization %</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.PctUtilized || 'N/A')">{{formatPercentage(debtorDetails?.PctUtilized)}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">AIG Coverage</p>
                                <p class="title1">{{formatCurrency(debtorDetails?.AIGLimit)}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Net Terms</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.Terms || 'N/A')">{{debtorDetails?.Terms || 'N/A'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Risk Trend</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{'TBD'}}</p>
                            </div>
                        </div>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">DSO All</p>
                                <p class="title1">{{ math.round(debtorDetails?.DSOAll) }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">DSO90</p>
                                <p class="title1">{{ math.round(debtorDetails?.DSO90) }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">DSO60</p>
                                <p class="title1">{{ math.round(debtorDetails?.DSO60) }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">DSO30</p>
                                <p class="title1">{{ math.round(debtorDetails?.DSO30) }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Internal Rating</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.CalcRateCode || 'N/A', 'InternalRating')">{{ debtorDetails?.CalcRateCode || 'N/A' }}</p>
                            </div>
                        </div>

                        
                        <div style="display: flex; align-items: center; gap: 50px;">
                            <p matBadge="External" matBadgeOverlap="false" class="title2 Ansonia-badge">Ansonia</p>
                            <mat-icon color="primary" (click)="getAnsoniaReportLink(debtorDetails)" class="input-icon ms-2 icon-hover-effect">link</mat-icon>
                        </div>
                        <div class="flex-row Ansonia-section">
                            <div class="flex-column">
                                <p class="text2">Last Updated</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.AnsoniaLastUpdate || 'N/A')">
                                    {{ debtorDetails?.AnsoniaLastUpdate ? debtorDetails?.AnsoniaLastUpdate.split(' ')[0] : "N/A" }}
                                </p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Risk Score</p>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.AnsoniaRiskScore || 'N/A', 'AnsoniaRiskScore')">
                                        {{ debtorDetails?.AnsoniaRiskScore || "N/A" }}
                                    </p>
                                    <p class="text3">{{ descriptionByValueAndType(debtorDetails?.AnsoniaRiskScore, 'AnsoniaRiskScore') }}</p>
                                </div>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Rating</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.AnsoniaRating || 'N/A')">
                                    {{ debtorDetails?.AnsoniaRating || "N/A" }}
                                </p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Avg days to pay</p>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.AnsoniaAvgDaysToPay || 'N/A')">
                                        {{ debtorDetails?.AnsoniaAvgDaysToPay || "N/A" }}
                                    </p>
                                    <p class="text3">Days</p>
                                </div>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Avg Balance</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.AnsoniaAvgBalance ? 'Normal text' : 'N/A')">
                                    {{ debtorDetails?.AnsoniaAvgBalance ? formatCurrency(debtorDetails?.AnsoniaAvgBalance) : "N/A" }}
                                </p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">High Balance</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.AnsoniaHighBalance ? 'Normal text' : 'N/A')">
                                    {{ debtorDetails?.AnsoniaHighBalance ? formatCurrency(debtorDetails?.AnsoniaHighBalance) : "N/A" }}
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 50px;">
                            <p matBadge="External" matBadgeOverlap="false" class="title2 DUNS-badge">DUNS</p></div>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Risk Score</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{'TBD'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">D&B Rating</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{'TBD'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Paydex</p>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{'TBD'}}</p>
                                </div>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">MCR</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{ "TBD" }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">High Balance</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{ "TBD" }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">DS/FC</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{ "TBD" }}</p>
                            </div>
                        </div>
                    </div> 
                </mat-card>
            </div>
            <!-- Client relationship analsysis card -->
            <div class="equal-height-column" style="flex: 3;">
                <mat-card appearance="raised" class="card-container-v2">
                    <div class="card-base">
                        <p class="title2">Client Relationship Analysis</p>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Debtor's Concentration on Client Facility</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(this.DebtorConcentrationPercentage)">{{this.DebtorConcentrationPercentage}}</p>
                            </div>
                        </div>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Credit Limit Utilization by Client</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(this.ClientConcentrationPercentage)">{{this.ClientConcentrationPercentage}}</p>
                            </div>
                        </div>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Dilution %</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.DilutionPct || 'N/A')">{{ debtorDetails?.DilutionPct| percent: '1.0-2' }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider" style="margin-left: 0px;"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Exp In Months</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{ 'TBD' }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Research Date</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{ 'TBD' }}</p>
                            </div>
                        </div>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Credit Override</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{ 'TBD' }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Relationship No Buy</p>
                                <p class="title1" [ngClass]="textColorByValueAndType('TBD')">{{ 'TBD' }}</p>
                            </div>
                        </div>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Relationship Documents</p>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <mat-icon color="primary" class="icon-hover-effect" (click)="openAgingDocumentsDialog('view')">manage_search</mat-icon>
                                    <mat-icon color="primary" class="icon-hover-effect" (click)="openAgingDocumentsDialog('upload')">upload_file</mat-icon>
                                </div>
                            </div>
                        </div>
                    </div>
                </mat-card>
            </div>
        </div>

        <!-- receivables cards -->
        <div class="equal-height-row">
            <div class="equal-height-column">
                <mat-card appearance="raised" class="card-container-v2">
                    <!-- Loading spinner overlay -->
                    <div *ngIf="loadingCurrentDebtorRelationship" class="loading-overlay">
                        <mat-spinner diameter="40"></mat-spinner>
                    </div>
                    <div class="card-base" [style.opacity]="loadingCurrentDebtorRelationship ? '0.3' : '1'">
                        <p class="title2">{{ticketData.Client}} Relationship</p>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Total AR</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(currentClientsRelationship?.Balance || 'N/A')">
                                    {{ currentClientsRelationship?.Balance ? formatCurrency(currentClientsRelationship?.Balance) : 'N/A' }}
                                </p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Past due balance</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(currentClientsRelationship?.PastDue || 'N/A')">
                                    {{ currentClientsRelationship?.PastDue ? formatCurrency(currentClientsRelationship?.PastDue) : 'N/A' }}
                                </p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">DSO</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(currentDebtorRelationship?.DSOAll || 'N/A')">
                                    {{ currentDebtorRelationship?.DSOAll ? math.round(currentDebtorRelationship?.DSOAll) : 'N/A' }}
                                </p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Disputed invoice</p>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <p class="title1" [ngClass]="textColorByValueAndType(currentClientsRelationship?.DisputesPct || 'N/A')">
                                        {{ currentClientsRelationship?.DisputesPct ? formatPercentage(currentClientsRelationship?.DisputesPct) : 'N/A' }}
                                    </p>
                                    <p class="text3">{{ currentClientsRelationship?.DisputeAmt ? formatCurrency(currentClientsRelationship?.DisputeAmt) : 'N/A' }}</p>
                                </div>
                            </div>
                        </div>
                        <p class="title2">Aging Breakdown</p>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">0-30</p>
                                <p class="title1 aging-0-30" style="margin-bottom: 0px;">{{calculatePercentage(currentDebtorRelationship?.Age0to30, currentDebtorRelationship?.Balance)}}</p>
                                <p class="title3">{{formatCurrency(currentDebtorRelationship?.Age0to30?.split('.')[0])}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">31-60</p>
                                <p class="title1 aging-31-60" style="margin-bottom: 0px;">{{calculatePercentage(currentDebtorRelationship?.Age31to60, currentDebtorRelationship?.Balance)}}</p>
                                <p class="title3">{{formatCurrency(currentDebtorRelationship?.Age31to60?.split('.')[0])}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">61-90</p>
                                <p class="title1 aging-61-90" style="margin-bottom: 0px;">{{calculatePercentage(currentDebtorRelationship?.Age61to90, currentDebtorRelationship?.Balance)}}</p>
                                <p class="title3">{{formatCurrency(currentDebtorRelationship?.Age61to90?.split('.')[0])}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">91+</p>
                                <p class="title1 aging-91-plus" style="margin-bottom: 0px;">
                                    {{calculatePercentage(getSumOfArray([currentDebtorRelationship?.Age91to120, currentDebtorRelationship?.Age121to150, currentDebtorRelationship?.Age151to180, currentDebtorRelationship?.AgeOver180])+'', currentDebtorRelationship?.Balance)}}
                                </p>
                                <p class="title3">
                                    {{formatCurrency(currentDebtorRelationship?.Age91to120?.split('.')[0], [currentDebtorRelationship?.Age121to150?.split('.')[0], currentDebtorRelationship?.Age151to180?.split('.')[0], currentDebtorRelationship?.AgeOver180?.split('.')[0]])}}
                                </p>
                            </div>
                        </div>
                    </div>
                </mat-card>
            </div>
            <!-- Client relationship analsysis card -->
            <div class="equal-height-column">
                <mat-card appearance="raised" class="card-container-v2">
                    <div class="card-base">
                        <div style="margin-bottom: 8px;">
                            <p class="title2" style="display: inline;">All Clients Relationship</p>
                            <p class="title2" style="display: inline; visibility: hidden">{{(ticketData?.Client + ' Relationship').slice(21)}}</p>
                        </div>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Total AR</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.Balance || 'N/A')">
                                    {{ debtorDetails?.Balance ? formatCurrency(debtorDetails?.Balance) : 'N/A' }}
                                </p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Past due balance</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.PastDue || 'N/A')">
                                    {{ debtorDetails?.PastDue ? formatCurrency(debtorDetails?.PastDue) : 'N/A' }}
                                </p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">DSO</p>
                                <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.DSOAll || 'N/A')">{{ debtorDetails?.DSOAll ? math.round(debtorDetails?.DSOAll) : 'N/A' }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Disputed invoice</p>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <p class="title1" [ngClass]="textColorByValueAndType(debtorDetails?.DisputesPct || 'N/A')">
                                        {{ formatPercentage(debtorDetails?.DisputesPct) }}
                                    </p>
                                    <p class="text3">{{ debtorDetails?.DisputeAmt ? formatCurrency(debtorDetails?.DisputeAmt) : 'N/A' }}</p>
                                </div>
                            </div>
                        </div>
                        <p class="title2">Aging Breakdown</p>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">0-30</p>
                                <p class="title1 aging-0-30" style="margin-bottom: 0px;">{{calculatePercentage(debtorDetails?.Age0to30, debtorDetails?.Balance)}}</p>
                                <p class="title3">{{formatCurrency(debtorDetails?.Age0to30.split('.')[0])}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">31-60</p>
                                <p class="title1 aging-31-60" style="margin-bottom: 0px;">{{calculatePercentage(debtorDetails?.Age31to60, debtorDetails?.Balance)}}</p>
                                <p class="title3">{{formatCurrency(debtorDetails?.Age31to60.split('.')[0])}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">61-90</p>
                                <p class="title1 aging-61-90" style="margin-bottom: 0px;">{{calculatePercentage(debtorDetails?.Age61to90, debtorDetails?.Balance)}}</p>
                                <p class="title3">{{formatCurrency(debtorDetails?.Age61to90.split('.')[0])}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">91+</p>
                                <p class="title1 aging-91-plus" style="margin-bottom: 0px;">{{calculatePercentage(getSumOfArray([debtorDetails?.Age91to120, debtorDetails?.Age121to150, debtorDetails?.Age151to180, debtorDetails?.AgeOver180])+'', debtorDetails?.Balance)}}</p>
                                <p class="title3">{{formatCurrency(debtorDetails?.Age91to120.split('.')[0], [debtorDetails?.Age121to150.split('.')[0], debtorDetails?.Age151to180.split('.')[0], debtorDetails?.AgeOver180.split('.')[0]])}}</p>
                            </div>
                        </div>
                    </div>
                </mat-card>
            </div>
        </div>

        <!-- payment behaviour card -->
        <mat-card appearance="raised" class="card-container-v2">
            <div class="card-base">
                <p class="title2">Payment Behaviour</p>
                <div class="flex-row">
                    <div class="flex-column">
                        <p class="text2">Last Payment</p>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <p class="title1" [ngClass]="textColorByValueAndType(calculateGapDays(debtorDetails?.LastPmtDate))">{{calculateGapDays(debtorDetails?.LastPmtDate)}}</p>
                            <p class="title1" [ngClass]="textColorByValueAndType(descriptionByValueAndType(calculateGapDays(debtorDetails?.LastPmtDate), 'DiffDaysLastPayment'), 'DiffDaysLastPayment')">
                                {{descriptionByValueAndType(calculateGapDays(debtorDetails?.LastPmtDate), 'DiffDaysLastPayment')}}
                            </p>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <p class="text1 t1-clickable" [ngClass]="textColorByValueAndType(debtorDetails?.LastPmtDate ? 'Normal text' : 'N/A')" (click)="openChecqueSearchDialog(debtorDetails?.DebtorKey)">
                                {{ debtorDetails?.LastPmtDate ? (debtorDetails?.LastPmtDate | date:"yyyy-MM-dd") : 'N/A' }}
                            </p>
                        </div>
                    </div>
                </div>
                <p class="title2">Months Combined Trend Chart</p>
                <div style="width: 100%; height: 400px; display: flex; justify-content: center; align-items: center; background-color: #f5f5f5; border-radius: 10px;">
                    <canvas #combinedLineChart style="max-height: 400px;"></canvas>
                </div>
            </div>
        </mat-card>
        
        <!-- Debtor Performance Calculator card -->
        <mat-card *ngIf="performanceResults" appearance="raised" class="card-container-v2">
            <div class="card-base">
                <p class="title2">Debtor Performance Assessment - Internal Only</p>
                <div class="flex-row">
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Status</p>
                        <div class="performance-pill" [ngClass]="performanceResults.statusClass">
                            {{ performanceResults.status }}
                        </div>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Utilization</p>
                        <p class="title1">{{ performanceResults.utilization }}%</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Override</p>
                        <p class="title3">{{ performanceResults.override }}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Weighted Risk Score</p>
                        <p class="title1">{{ performanceResults.score }}</p>
                    </div>
                </div>
                <div class="flex-row">
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Suggestion</p>
                        <p class="title3">{{ performanceResults.suggestion }}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Suggested New Credit Limit</p>
                        <p class="title1">${{ performanceResults.newCreditLimit.toLocaleString() }}</p>
                    </div>
                </div>
                
                <!-- N status explanation -->
                <div *ngIf="performanceResults.status === 'N'" style="margin-top: 16px;">
                    <mat-divider></mat-divider>
                    <p class="title2" style="margin-top: 16px;">New Debtor Guidelines:</p>
                    <div class="flex-row">
                        <div class="flex-column">
                            <p class="text2"><strong>Low Exposure:</strong> small trial credit ($5k–$10k)</p>
                            <p class="text2"><strong>Moderate Exposure:</strong> if external refs A/B, 10–15% of credit limit</p>
                            <p class="text2"><strong>High Restriction:</strong> no open credit; prepay until 1–2 cycles</p>
                        </div>
                    </div>
                </div>
            </div>
        </mat-card>





        <!-- old debtor information cards -->
        <!-- <mat-grid-list cols="1" rowHeight="260px" style="margin-bottom: 16px;">
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div class="table-container">                            
                        <table class="bordered-table">
                            <tr>                                
                                <th class="header" style="width: 50%;">Debtor name</th>
                                <th class="header" style="width: 50%;">Client name</th>             
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 50%;">{{ ticketData.Debtor }}</td>
                                <td class="cell" style="width: 50%;">{{ ticketData.Client }}</td>                                                       
                            </tr>                                
                        </table>
                        <table class="bordered-table">
                            <tr>                                
                                <th class="header" style="width: 25%;">Overall credit limit</th>
                                <th class="header" style="width: 25%;">AIG limit</th>
                                <th class="header" style="width: 25%;">Outstanding balance</th>
                                <th class="header" style="width: 25%;">Credit limit utilization</th>
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 25%;">{{ formatCurrency(ticketData.TotalCreditLimit) }}</td>
                                <td class="cell" style="width: 25%;">{{ formatCurrency(debtorDetails?.AIGLimit) }}</td>
                                <td class="cell" style="width: 25%;">
                                    {{ formatCurrency(debtorDetails?.Balance) }}
                                </td>
                                <td class="cell" style="width: 25%;">{{ formatPercentage(debtorDetails?.PctUtilized) }}</td>
                            </tr>                                
                        </table>
                        <table class="bordered-table">
                            <tr>
                                <th class="header" style="width: 25%;">Dilution %</th>
                                <th class="header" style="width: 25%;">Client | Debtor Concentration %</th>
                                <th class="header" style="width: 25%;">Last payment date</th>
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 25%;">{{ debtorDetails?.DilutionPct| percent: '1.0-2' }}</td>
                                <td class="cell" style="width: 25%;">{{ this.ClientConcentrationPercentage + ' | ' + this.DebtorConcentrationPercentage }}</td>
                                <td class="cell" style="width: 25%; cursor: pointer; color: rgb(58, 138, 218);" (click)="openChecqueSearchDialog(debtorDetails?.DebtorKey)">{{ debtorDetails?.LastPmtDate ? (debtorDetails?.LastPmtDate | date:"MM/dd/yyyy") : 'N/A' }}</td>
                            </tr>                                
                        </table>
                        <table class="bordered-table">
                            <tr>
                                <th class="header" style="width: 20%;">Total AR</th>
                                <th class="header" style="width: 20%;">0-30 | %</th>
                                <th class="header" style="width: 20%;">31-60 | %</th>
                                <th class="header" style="width: 20%;">61-90 | %</th>
                                <th class="header" style="width: 20%;">≥ 91 | %</th>             
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Balance) }}</td>
                                <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age0to30) + ' | ' +  calculatePercentage(debtorDetails?.Age0to30, debtorDetails?.Balance) }}</td>
                                <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age31to60) + ' | ' +  calculatePercentage(debtorDetails?.Age31to60, debtorDetails?.Balance) }}</td>
                                <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age61to90) + ' | ' +  calculatePercentage(debtorDetails?.Age61to90, debtorDetails?.Balance) }}</td>
                                <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age91to120, [debtorDetails?.Age121to150, debtorDetails?.Age151to180, debtorDetails?.AgeOver180]) + ' | ' +  calculatePercentage(getSumOfArray([debtorDetails?.Age91to120, debtorDetails?.Age121to150, debtorDetails?.Age151to180, debtorDetails?.AgeOver180])+'', debtorDetails?.Balance) }}</td>                                                
                            </tr>                                
                        </table>
                    </div> 
                </mat-card>
            </mat-grid-tile>
        </mat-grid-list>
        
        <mat-grid-list cols="2" rowHeight="160px" style="margin-bottom: 16px;">
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 20%;">DSO All</th>
                                    <th class="header" style="width: 20%;">DSO 90</th>
                                    <th class="header" style="width: 20%;">DSO 60</th>
                                    <th class="header" style="width: 20%;">DSO 30</th>
                                    <th class="header" style="width: 20%;">Rate code</th>             
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSOAll) }}</td>
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSO90) }}</td>
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSO60) }}</td>
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSO30) }}</td>
                                    <td class="cell" style="width: 20%;">{{ debtorDetails?.CalcRateCode }}</td>                                                
                                </tr>                                
                            </table>
                        </div> 
                </mat-card>
            </mat-grid-tile>
            
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                        <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 33.33%;">Last updated</th>
                                    <th class="header" style="width: 33.33%;">Risk score</th>
                                    <th class="header" style="width: 33.33%;">Rating</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaLastUpdate || "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaRiskScore || "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaRating || "N/A" }}</td>
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 33.33%;">Average days to pay</th>
                                    <th class="header" style="width: 33.33%;">Average balance</th>
                                    <th class="header" style="width: 33.33%;">High balance</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaAvgDaysToPay || "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaAvgBalance ? formatCurrency(debtorDetails?.AnsoniaAvgBalance) : "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaHighBalance ? formatCurrency(debtorDetails?.AnsoniaHighBalance) : "N/A" }}</td>
                                </tr>                                
                            </table>
                        </div> 
                </mat-card>
            </mat-grid-tile>
        </mat-grid-list>

        <mat-grid-list cols="1" rowHeight="220px" style="margin-bottom: 16px;">
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div>
                        <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 100%;">Warning</th>          
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 100%;">{{ debtorDetails?.Warning || "N/A" }}</td>                                             
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 100%;">Credit Information</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 100%;">{{ debtorDetails?.CredNote || "N/A" }}</td> 
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 100%;">Instructions</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 100%;">{{ debtorDetails?.Notes || "N/A" }}</td>
                                </tr>                                
                            </table>
                        </div> 
                    </div>
                </mat-card>
            </mat-grid-tile>
        </mat-grid-list>
            
        <mat-grid-list cols="1" rowHeight="300px" style="margin-bottom: 16px;">
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 75%;">Address</th>
                                    <th class="header" style="width: 25%;">Alternate address</th>    
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 75%;">{{ formatAddress([debtorDetails?.Addr1, debtorDetails?.City, debtorDetails?.State, debtorDetails?.Country, debtorDetails?.ZipCode]) }}</td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.Addr2 }}</td>  
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 25%;">Insutructions</th>
                                    <th class="header" style="width: 25%;">DUNS</th>  
                                    <th class="header" style="width: 25%;">MC#</th>
                                    <th class="header" style="width: 25%;">Ansonia Report</th>
                                </tr>                               
                                <tr class="table-row"> 
                                    <td class="cell" style="width: 25%;">{{ ticketData.Industry }}</td>
                                    <td class="cell" style="width: 25%;">
                                        <div class="d-flex align-items-center w-100">
                                            {{ debtorDetails?.DbDunsNo }}
                                            <mat-icon color="primary" (click)="searchDuns(debtorDetails)" class="input-icon ms-2 icon-hover-effect">find_replace</mat-icon>
                                        </div>
                                    </td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.MotorCarrNo }}</td>
                                    <td class="cell" style="width: 25%;"><mat-icon color="primary" (click)="getAnsoniaReportLink(debtorDetails)" class="input-icon ms-2 icon-hover-effect">link</mat-icon></td>
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 50%;">Email</th>
                                    <th class="header" style="width: 25%;">Phone1</th>
                                    <th class="header" style="width: 25%;">Phone2</th> 
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 50%;">{{ formatEmail(debtorDetails?.Email) }}</td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.Phone1 }}</td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.Phone2 }}</td> 
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 80%;">No Buy Code</th>
                                    <th class="header" style="width: 20%;">Edit Debtor</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 80%;">
                                        <mat-select id="DisputeCode" [(ngModel)]="selectedNoBuyKey" (selectionChange)="onNoBuyCodeChange($event)">
                                            @if (selectedNoBuyKey === '-1') {
                                            <mat-option value='-1' disabled>{{ debtorDetails?.NoBuyCode }}</mat-option>
                                            }
                                            <mat-option value=''>{{"Clear No Buy Code"}}</mat-option>
                                            @for (noBuyCode of noBuyCodeList; track noBuyCode.DisputeCodeKey) {
                                            <mat-option value={{noBuyCode.DisputeCodeKey}}>{{noBuyCode.DisputeCode}}</mat-option>
                                            }
                                        </mat-select>
                                    </td>

                                    <td class="cell" style="width: 20%;"><mat-icon color="primary" (click)="editDebtor(debtorDetails)" class="input-icon ms-2 icon-hover-effect">edit</mat-icon></td> 
                                </tr>                                
                            </table>
                        </div> 
                </mat-card>
            </mat-grid-tile>
        </mat-grid-list>
         -->


        <!-- trend analysis table and chart 1 -->
        <mat-grid-list cols="1" rowHeight="auto">
            <mat-card appearance="raised" class="mat-card-trend-table">
                <div class="col-md-12">
                    <!-- <label class="form-label"><strong>Periods</strong></label>
                    <br> -->
                    <mat-accordion>
                        <mat-expansion-panel (opened)="table1OpenState.set(true)" (closed)="table1OpenState.set(false)"  style="background-color: rgb(255, 255, 255);">
                            <mat-expansion-panel-header>
                            <mat-panel-title> Trend Analysis for {{ticketData.Debtor}} - {{ticketData.Client}} </mat-panel-title>
                            <mat-panel-description>
                                Click to {{!table1OpenState() ? 'open' : 'closed'}} table
                            </mat-panel-description>
                            </mat-expansion-panel-header>

                            <mat-form-field class="periods-selection">
                            <mat-label>Periods</mat-label>
                            <select [(ngModel)]="trendPeriodChar" (change)="onTrendPeriodChange($event)" matNativeControl required>
                                <option value="M">Months</option>
                                <option value="Q">Quarters</option>
                                <option value="Y">Years</option>
                            </select>
                            </mat-form-field>

                            <div style="overflow-x: auto; width: 100%;">
                                <table mat-table [dataSource]="ticketingTrendDataVertical" matTableExporter #exporter="matTableExporter"
                                    class="mat-elevation-z8 trend-table">
                                    @for (it of displayedColumnsVertical; track it) {
                                    <ng-container matColumnDef={{it}} sticky="{{it === 'Period' ? 'true' : 'false'}}">
                                        <th mat-header-cell *matHeaderCellDef> {{formatTrendTableHeader(it)}} </th>
                                        <td mat-cell *matCellDef="let element"> {{element[it]}} </td>
                                    </ng-container>
                                    }
                                    <tr mat-header-row *matHeaderRowDef="displayedColumnsVertical"></tr>
                                    <tr mat-row *matRowDef="let row; columns: displayedColumnsVertical;"></tr>
                                </table>
                            </div>
                    
                        </mat-expansion-panel>
                    </mat-accordion>

                    <mat-accordion>
                        <mat-expansion-panel (opened)="panel1OpenState.set(true)" (closed)="panel1OpenState.set(false)"  style="background-color: rgb(255, 255, 255);">
                            <mat-expansion-panel-header>
                            <mat-panel-title> Trend Chart </mat-panel-title>
                            <mat-panel-description>
                                Click to {{!panel1OpenState() ? 'open' : 'closed'}} chart
                            </mat-panel-description>
                            </mat-expansion-panel-header>
                                <div class="col-md-12">
                                    <select class="form-column-selection" [(ngModel)]="trendColumn" (change)="onTrendColumnChange()">
                                    <option value="Purchases">Purchases</option>
                                    <option value="PurchasesAvg">Average</option>
                                    <option value="Payments">Payments</option>
                                    <option value="PurchasesNo">Invoices</option>
                                    <option value="PaiTodZero">Paid to zero</option>
                                    <option value="Recoursed">Recoursed</option>
                                    <option value="AvgWeightedDays">Average Weighted Days</option>
                                    </select>
                                    
                                    <div style="width: 100%; height: 500px;">
                                    <canvas #trendBarChart></canvas>
                                    </div>
                                </div>
                        </mat-expansion-panel>
                    </mat-accordion>

                </div>
            </mat-card>
        </mat-grid-list>
        <!-- trend analysis table and chart 2 -->
        <mat-grid-list cols="1" rowHeight="auto">
            <mat-card appearance="raised" class="mat-card-trend-table">
                <div class="col-md-12">

                    <mat-accordion>
                        <mat-expansion-panel (opened)="panel2OpenState.set(true)" (closed)="panel2OpenState.set(false)"  style="background-color: rgb(255, 255, 255);">
                            <mat-expansion-panel-header>
                            <mat-panel-title> Trend Analysis for {{ticketData.Debtor}} - All Clients </mat-panel-title>
                            <mat-panel-description>
                                Click to {{!panel2OpenState() ? 'open' : 'closed'}} table
                            </mat-panel-description>
                            </mat-expansion-panel-header>

                            <mat-form-field class="periods-selection">
                            <mat-label>Periods</mat-label>
                            <select [(ngModel)]="trendPeriodChar2" (change)="onTrendPeriod2Change($event)" matNativeControl required>
                                <option value="M">Months</option>
                                <option value="Q">Quarters</option>
                                <option value="Y">Years</option>
                            </select>
                            </mat-form-field>

                            <div style="overflow-x: auto; width: 100%;">
                                <table mat-table [dataSource]="ticketingTrendDataVertical2" matTableExporter #exporter="matTableExporter"
                                    class="mat-elevation-z8 trend-table">
                                    @for (it of displayedColumnsVertical2; track it) {
                                    <ng-container matColumnDef={{it}} sticky="{{it === 'Period' ? 'true' : 'false'}}">
                                        <th mat-header-cell *matHeaderCellDef> {{formatTrendTableHeader(it)}} </th>
                                        <td mat-cell *matCellDef="let element"> {{element[it]}} </td>
                                    </ng-container>
                                    }
                                    <tr mat-header-row *matHeaderRowDef="displayedColumnsVertical2"></tr>
                                    <tr mat-row *matRowDef="let row; columns: displayedColumnsVertical2;"></tr>
                                </table>
                            </div>
                    
                        </mat-expansion-panel>
                    </mat-accordion>

                    <mat-accordion>
                        <mat-expansion-panel (opened)="panel2OpenState.set(true)" (closed)="panel2OpenState.set(false)"  style="background-color: rgb(255, 255, 255);">
                            <mat-expansion-panel-header>
                            <mat-panel-title> Trend Chart </mat-panel-title>
                            <mat-panel-description>
                                Click to {{!panel2OpenState() ? 'open' : 'closed'}} chart
                            </mat-panel-description>
                            </mat-expansion-panel-header>
                                <div class="col-md-12">
                                    <select class="form-column-selection" [(ngModel)]="trendColumn2" (change)="onTrendColumnChange2()">
                                    <option value="Purchases">Purchases</option>
                                    <option value="PurchasesAvg">Average</option>
                                    <option value="Payments">Payments</option>
                                    <option value="PurchasesNo">Invoices</option>
                                    <option value="PaiTodZero">Paid to zero</option>
                                    <option value="Recoursed">Recoursed</option>
                                    <option value="AvgWeightedDays">Average Weighted Days</option>
                                    </select>
                                    
                                    <div style="width: 100%; height: 500px;">
                                    <canvas #trendBarChart2></canvas>
                                    </div>
                                </div>
                        </mat-expansion-panel>
                    </mat-accordion>

                </div>
            </mat-card>
        </mat-grid-list>

        


    </div>
</mat-drawer-container>