<mat-drawer-container class="full-screen-drawer-container" [hasBackdrop]="true">
    <mat-drawer #drawer [mode]="'over'" positionBottom="bottom">
        <!-- Drawer content -->
        <div class="bottom-drawer-content">
            <div class="drawer-header">
                <h5>DUNS Search Results</h5>
                <div class="search-actions">
                    <button mat-raised-button color="primary" (click)="searchDunsByNameOnly()">
                        <mat-icon>search</mat-icon> Search By Name Only
                    </button>
                    <button mat-icon-button (click)="drawer.close()">
                        <mat-icon>close</mat-icon>
                    </button>
                </div>
            </div>
            <p><b>Company: </b>{{debtorName}}&nbsp;&nbsp;&nbsp;&nbsp;<b>Address: </b>{{debtorFullAddress}}</p>
            <mat-divider></mat-divider>
            <!-- Loading indicator -->
            <div *ngIf="loadingDuns" class="loading-spinner">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Searching for debtor matches...</p>
            </div>
            <!-- Results area with cards -->
            <div *ngIf="!loadingDuns" class="duns-results">
                <h5 *ngIf="dunsMatches.length > 0">Matching Companies ({{dunsMatches.length}})</h5>
                <p *ngIf="dunsMatches.length === 0">No matches found. Please try search by name only.</p>
                
                <div class="duns-cards-container">
                    <app-duns-card *ngFor="let match of dunsMatches" [dunsInfo]="match" (selectDunsCompany)="updateDebtorWithDunsInfo(match)"></app-duns-card>
                </div>
            </div>
            <!-- <div class="drawer-info">
            </div> -->
        </div>
    </mat-drawer>

    <div class="analysis-container">

        <!-- old debtor information cards -->
        <mat-grid-list cols="1" rowHeight="300px" style="margin-bottom: 16px;">
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div class="table-container">                            
                        <table class="bordered-table">
                            <tr>                                
                                <th class="header" style="width: 50%;">Debtor name</th>
                                <th class="header" style="width: 50%;">Client name</th>             
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 50%;">{{ ticketData.Debtor }}</td>
                                <td class="cell" style="width: 50%;">{{ ticketData.Client }}</td>                                                       
                            </tr>                                
                        </table>
                        <table class="bordered-table">
                            <tr>                                
                                <th class="header" style="width: 33.33%;">Overall credit limit</th>
                                <th class="header" style="width: 33.33%;">AIG limit</th>
                                <th class="header" style="width: 33.33%;">Outstanding balance</th>
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 33.33%;">{{ formatCurrency(ticketData.TotalCreditLimit) }}</td>
                                <td class="cell" style="width: 33.33%;">{{ formatCurrency(debtorDetails?.AIGLimit) }}</td>
                                <td class="cell" style="width: 33.33%;">
                                    <div class="d-flex align-items-center w-100">
                                        {{ formatCurrency(debtorDetails?.Balance) }} 
                                        <mat-icon color="primary" class="input-icon ms-2 icon-hover-effect" 
                                        (click)="onMoreDetailsClick('balance')">
                                            {{showDetailedView === 'balance' ? 'visibility' : 'more_horiz'}}
                                        </mat-icon>
                                    </div>
                                </td>
                            </tr>                                
                        </table>
                        <table class="bordered-table">
                            <tr>
                                <th class="header" style="width: 33.33%;">Credit limit utilization</th>
                                <th class="header" style="width: 33.33%;">Credit rating</th>
                                <th class="header" style="width: 33.33%;">Credit Ansonia</th>
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 33.33%;">{{ formatPercentage(debtorDetails?.PctUtilized) }}</td>
                                <td class="cell" style="width: 33.33%;">
                                    <mat-icon color="primary" class="input-icon ms-2 icon-hover-effect" 
                                    (click)="onMoreDetailsClick('creditRating')">
                                        {{showDetailedView === 'creditRating' ? 'visibility' : 'more_horiz'}}
                                    </mat-icon>
                                </td>
                                <td class="cell" style="width: 33.33%;">
                                    <mat-icon color="primary" class="input-icon ms-2 icon-hover-effect" 
                                    (click)="onMoreDetailsClick('creditAnsonia')">
                                        {{showDetailedView === 'creditAnsonia' ? 'visibility' : 'more_horiz'}}
                                    </mat-icon>
                                </td>
                            </tr>                                
                        </table>
                        <table class="bordered-table">
                            <tr>
                                <th class="header" style="width: 33.33%;">Dilution %</th>
                                <th class="header" style="width: 33.33%;">Client | Debtor Concentration %</th>
                                <th class="header" style="width: 33.33%;">Last payment date</th>
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 33.33%;">{{ debtorDetails?.DilutionPct| percent: '1.0-2' }}</td>
                                <td class="cell" style="width: 33.33%;">{{ this.ClientConcentrationPercentage + ' | ' + this.DebtorConcentrationPercentage }}</td>
                                <td class="cell" style="width: 33.33%; cursor: pointer; color: rgb(58, 138, 218);" (click)="openChecqueSearchDialog(debtorDetails?.DebtorKey)">{{ debtorDetails?.LastPmtDate ? (debtorDetails?.LastPmtDate | date:"MM/dd/yyyy") : 'N/A' }}</td>
                            </tr>                                
                        </table> 
                    </div> 
                </mat-card>
            </mat-grid-tile>
        </mat-grid-list>

        <mat-grid-list cols="1" rowHeight="220px" style="margin-bottom: 16px;">
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div>
                        <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 100%;">Warning</th>          
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 100%;">{{ debtorDetails?.Warning || "N/A" }}</td>                                             
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 100%;">Credit Information</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 100%;">{{ debtorDetails?.CredNote || "N/A" }}</td> 
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 100%;">Instructions</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 100%;">{{ debtorDetails?.Notes || "N/A" }}</td>
                                </tr>                                
                            </table>
                        </div> 
                    </div>
                </mat-card>
            </mat-grid-tile>
        </mat-grid-list>
            
        <mat-grid-list cols="1" rowHeight="350px" style="margin-bottom: 16px;">
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 20%;">Total AR</th>
                                    <th class="header" style="width: 20%;">0-30 | %</th>
                                    <th class="header" style="width: 20%;">31-60 | %</th>
                                    <th class="header" style="width: 20%;">61-90 | %</th>
                                    <th class="header" style="width: 20%;">≥ 91 | %</th>             
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Balance) }}</td>
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age0to30) + ' | ' +  calculatePercentage(debtorDetails?.Age0to30, debtorDetails?.Balance) }}</td>
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age31to60) + ' | ' +  calculatePercentage(debtorDetails?.Age31to60, debtorDetails?.Balance) }}</td>
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age61to90) + ' | ' +  calculatePercentage(debtorDetails?.Age61to90, debtorDetails?.Balance) }}</td>
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age91to120, [debtorDetails?.Age121to150, debtorDetails?.Age151to180, debtorDetails?.AgeOver180]) + ' | ' +  calculatePercentage(getSumOfArray([debtorDetails?.Age91to120, debtorDetails?.Age121to150, debtorDetails?.Age151to180, debtorDetails?.AgeOver180])+'', debtorDetails?.Balance) }}</td>                                                
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 75%;">Address</th>
                                    <th class="header" style="width: 25%;">Alternate address</th>    
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 75%;">{{ formatAddress([debtorDetails?.Addr1, debtorDetails?.City, debtorDetails?.State, debtorDetails?.Country, debtorDetails?.ZipCode]) }}</td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.Addr2 }}</td>  
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 25%;">Insutructions</th>
                                    <th class="header" style="width: 25%;">DUNS</th>  
                                    <th class="header" style="width: 25%;">MC#</th>
                                    <th class="header" style="width: 25%;">Ansonia Report</th>
                                </tr>                               
                                <tr class="table-row"> 
                                    <td class="cell" style="width: 25%;">{{ ticketData.Industry }}</td>
                                    <td class="cell" style="width: 25%;">
                                        <div class="d-flex align-items-center w-100">
                                            {{ debtorDetails?.DbDunsNo }}
                                            <mat-icon color="primary" (click)="searchDuns(debtorDetails)" class="input-icon ms-2 icon-hover-effect">find_replace</mat-icon>
                                        </div>
                                    </td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.MotorCarrNo }}</td>
                                    <td class="cell" style="width: 25%;"><mat-icon color="primary" (click)="getAnsoniaReportLink(debtorDetails)" class="input-icon ms-2 icon-hover-effect">link</mat-icon></td>
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 50%;">Email</th>
                                    <th class="header" style="width: 25%;">Phone1</th>
                                    <th class="header" style="width: 25%;">Phone2</th> 
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 50%;">{{ formatEmail(debtorDetails?.Email) }}</td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.Phone1 }}</td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.Phone2 }}</td> 
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 80%;">No Buy Code</th>
                                    <th class="header" style="width: 20%;">Edit Debtor</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 80%;">
                                        <mat-select id="DisputeCode" [(ngModel)]="selectedNoBuyKey" (selectionChange)="onNoBuyCodeChange($event)">
                                            @if (selectedNoBuyKey === '-1') {
                                            <mat-option value='-1' disabled>{{ debtorDetails?.NoBuyCode }}</mat-option>
                                            }
                                            <mat-option value=''>{{"Clear No Buy Code"}}</mat-option>
                                            @for (noBuyCode of noBuyCodeList; track noBuyCode.DisputeCodeKey) {
                                            <mat-option value={{noBuyCode.DisputeCodeKey}}>{{noBuyCode.DisputeCode}}</mat-option>
                                            }
                                        </mat-select>
                                    </td>

                                    <td class="cell" style="width: 20%;"><mat-icon color="primary" (click)="editDebtor(debtorDetails)" class="input-icon ms-2 icon-hover-effect">edit</mat-icon></td> 
                                </tr>                                
                            </table>
                        </div> 
                </mat-card>
            </mat-grid-tile>
        </mat-grid-list>
        
        <mat-grid-list cols="2" rowHeight="200px" style="margin-bottom: 16px;">
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 20%;">DSO All</th>
                                    <th class="header" style="width: 20%;">DSO 90</th>
                                    <th class="header" style="width: 20%;">DSO 60</th>
                                    <th class="header" style="width: 20%;">DSO 30</th>
                                    <th class="header" style="width: 20%;">Rate code</th>             
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSOAll) }}</td>
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSO90) }}</td>
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSO60) }}</td>
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSO30) }}</td>
                                    <td class="cell" style="width: 20%;">{{ debtorDetails?.CalcRateCode }}</td>                                                
                                </tr>                                
                            </table>
                        </div> 
                </mat-card>
            </mat-grid-tile>
            
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                        <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 33.33%;">Last updated</th>
                                    <th class="header" style="width: 33.33%;">Risk score</th>
                                    <th class="header" style="width: 33.33%;">Rating</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaLastUpdate || "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaRiskScore || "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaRating || "N/A" }}</td>
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 33.33%;">Average days to pay</th>
                                    <th class="header" style="width: 33.33%;">Average balance</th>
                                    <th class="header" style="width: 33.33%;">High balance</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaAvgDaysToPay || "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaAvgBalance ? formatCurrency(debtorDetails?.AnsoniaAvgBalance) : "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaHighBalance ? formatCurrency(debtorDetails?.AnsoniaHighBalance) : "N/A" }}</td>
                                </tr>                                
                            </table>
                        </div> 
                </mat-card>
            </mat-grid-tile>
        </mat-grid-list>


        <!--<mat-grid-list cols="2" rowHeight="350px">
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div class="table-container">                            
                        <table class="bordered-table">
                            <tr>                                
                                <th class="header" style="width: 50%;">Debtor name</th>
                                <th class="header" style="width: 50%;">Client name</th>             
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 50%;">{{ ticketData.Debtor }}</td>
                                <td class="cell" style="width: 50%;">{{ ticketData.Client }}</td>                                                       
                            </tr>                                
                        </table>
                        <table class="bordered-table">
                            <tr>                                
                                <th class="header" style="width: 33.33%;">Overall credit limit</th>
                                <th class="header" style="width: 33.33%;">AIG limit</th>
                                <th class="header" style="width: 33.33%;">Outstanding balance</th>
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 33.33%;">{{ formatCurrency(ticketData.TotalCreditLimit) }}</td>
                                <td class="cell" style="width: 33.33%;">{{ formatCurrency(debtorDetails?.AIGLimit) }}</td>
                                <td class="cell" style="width: 33.33%;">
                                    <div class="d-flex align-items-center w-100">
                                        {{ formatCurrency(debtorDetails?.Balance) }} 
                                        <mat-icon color="primary" class="input-icon ms-2 icon-hover-effect" 
                                        (click)="onMoreDetailsClick('balance')">
                                            {{showDetailedView === 'balance' ? 'visibility' : 'more_horiz'}}
                                        </mat-icon>
                                    </div>
                                </td>
                            </tr>                                
                        </table>
                        <table class="bordered-table">
                            <tr>
                                <th class="header" style="width: 33.33%;">Credit limit utilization</th>
                                <th class="header" style="width: 33.33%;">Credit rating</th>
                                <th class="header" style="width: 33.33%;">Credit Ansonia</th>
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 33.33%;">{{ formatPercentage(debtorDetails?.PctUtilized) }}</td>
                                <td class="cell" style="width: 33.33%;">
                                    <mat-icon color="primary" class="input-icon ms-2 icon-hover-effect" 
                                    (click)="onMoreDetailsClick('creditRating')">
                                        {{showDetailedView === 'creditRating' ? 'visibility' : 'more_horiz'}}
                                    </mat-icon>
                                </td>
                                <td class="cell" style="width: 33.33%;">
                                    <mat-icon color="primary" class="input-icon ms-2 icon-hover-effect" 
                                    (click)="onMoreDetailsClick('creditAnsonia')">
                                        {{showDetailedView === 'creditAnsonia' ? 'visibility' : 'more_horiz'}}
                                    </mat-icon>
                                </td>
                            </tr>                                
                        </table>
                        <table class="bordered-table">
                            <tr>
                                <th class="header" style="width: 33.33%;">Dilution %</th>
                                <th class="header" style="width: 33.33%;">Client | Debtor Concentration %</th>
                                <th class="header" style="width: 33.33%;">Last payment date</th>
                            </tr>                               
                            <tr class="table-row">
                                <td class="cell" style="width: 33.33%;">{{ debtorDetails?.DilutionPct| percent: '1.0-2' }}</td>
                                <td class="cell" style="width: 33.33%;">{{ this.ClientConcentrationPercentage + ' | ' + this.DebtorConcentrationPercentage }}</td>
                                <td class="cell" style="width: 33.33%; cursor: pointer; color: rgb(58, 138, 218);" (click)="openChecqueSearchDialog(debtorDetails?.DebtorKey)">{{ debtorDetails?.LastPmtDate ? (debtorDetails?.LastPmtDate | date:"MM/dd/yyyy") : 'N/A' }}</td>
                            </tr>                                
                        </table> 
                    </div> 
                </mat-card>
            </mat-grid-tile>
            <mat-grid-tile>
                <mat-card appearance="raised" class="card-container">
                    <div *ngIf="showDetailedView === 'default'">
                        <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 100%;">Warning</th>          
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 100%;">{{ debtorDetails?.Warning || "N/A" }}</td>                                             
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 100%;">Credit Information</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 100%;">{{ debtorDetails?.CredNote || "N/A" }}</td> 
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 100%;">Instructions</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 100%;">{{ debtorDetails?.Notes || "N/A" }}</td>
                                </tr>                                
                            </table>
                        </div> 
                    </div>
                    <!~~ Blance details ~~>
                    <div *ngIf="showDetailedView === 'balance'">
                        <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 20%;">Total AR</th>
                                    <th class="header" style="width: 20%;">0-30 | %</th>
                                    <th class="header" style="width: 20%;">31-60 | %</th>
                                    <th class="header" style="width: 20%;">61-90 | %</th>
                                    <th class="header" style="width: 20%;">≥ 91 | %</th>             
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Balance) }}</td>
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age0to30) + ' | ' +  calculatePercentage(debtorDetails?.Age0to30, debtorDetails?.Balance) }}</td>
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age31to60) + ' | ' +  calculatePercentage(debtorDetails?.Age31to60, debtorDetails?.Balance) }}</td>
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age61to90) + ' | ' +  calculatePercentage(debtorDetails?.Age61to90, debtorDetails?.Balance) }}</td>
                                    <td class="cell" style="width: 20%;">{{ formatCurrency(debtorDetails?.Age91to120, [debtorDetails?.Age121to150, debtorDetails?.Age151to180, debtorDetails?.AgeOver180]) + ' | ' +  calculatePercentage(getSumOfArray([debtorDetails?.Age91to120, debtorDetails?.Age121to150, debtorDetails?.Age151to180, debtorDetails?.AgeOver180])+'', debtorDetails?.Balance) }}</td>                                                
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 75%;">Address</th>
                                    <th class="header" style="width: 25%;">Alternate address</th>    
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 75%;">{{ formatAddress([debtorDetails?.Addr1, debtorDetails?.City, debtorDetails?.State, debtorDetails?.Country, debtorDetails?.ZipCode]) }}</td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.Addr2 }}</td>  
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 25%;">Insutructions</th>
                                    <th class="header" style="width: 25%;">DUNS</th>  
                                    <th class="header" style="width: 25%;">MC#</th>
                                    <th class="header" style="width: 25%;">Ansonia Report</th>
                                </tr>                               
                                <tr class="table-row"> 
                                    <td class="cell" style="width: 25%;">{{ ticketData.Industry }}</td>
                                    <td class="cell" style="width: 25%;">
                                        <div class="d-flex align-items-center w-100">
                                            {{ debtorDetails?.DbDunsNo }}
                                            <mat-icon color="primary" (click)="searchDuns(debtorDetails)" class="input-icon ms-2 icon-hover-effect">find_replace</mat-icon>
                                        </div>
                                    </td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.MotorCarrNo }}</td>
                                    <td class="cell" style="width: 25%;"><mat-icon color="primary" (click)="getAnsoniaReportLink(debtorDetails)" class="input-icon ms-2 icon-hover-effect">link</mat-icon></td>
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 50%;">Email</th>
                                    <th class="header" style="width: 25%;">Phone1</th>
                                    <th class="header" style="width: 25%;">Phone2</th> 
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 50%;">{{ formatEmail(debtorDetails?.Email) }}</td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.Phone1 }}</td>
                                    <td class="cell" style="width: 25%;">{{ debtorDetails?.Phone2 }}</td> 
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 80%;">No Buy Code</th>
                                    <th class="header" style="width: 20%;">Edit Debtor</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 80%;">
                                        <mat-select id="DisputeCode" [(ngModel)]="selectedNoBuyKey" (selectionChange)="onNoBuyCodeChange($event)">
                                            @if (selectedNoBuyKey === '-1') {
                                            <mat-option value='-1' disabled>{{ debtorDetails?.NoBuyCode }}</mat-option>
                                            }
                                            <mat-option value=''>{{"Clear No Buy Code"}}</mat-option>
                                            @for (noBuyCode of noBuyCodeList; track noBuyCode.DisputeCodeKey) {
                                            <mat-option value={{noBuyCode.DisputeCodeKey}}>{{noBuyCode.DisputeCode}}</mat-option>
                                            }
                                        </mat-select>
                                    </td>

                                    <td class="cell" style="width: 20%;"><mat-icon color="primary" (click)="editDebtor(debtorDetails)" class="input-icon ms-2 icon-hover-effect">edit</mat-icon></td> 
                                </tr>                                
                            </table>
                        </div> 
                    </div>
                    <!~~ Credit Rating details ~~>
                    <div *ngIf="showDetailedView === 'creditRating'">
                        <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 20%;">DSO All</th>
                                    <th class="header" style="width: 20%;">DSO 90</th>
                                    <th class="header" style="width: 20%;">DSO 60</th>
                                    <th class="header" style="width: 20%;">DSO 30</th>
                                    <th class="header" style="width: 20%;">Rate code</th>             
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSOAll) }}</td>
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSO90) }}</td>
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSO60) }}</td>
                                    <td class="cell" style="width: 20%;">{{ math.round(debtorDetails?.DSO30) }}</td>
                                    <td class="cell" style="width: 20%;">{{ debtorDetails?.CalcRateCode }}</td>                                                
                                </tr>                                
                            </table>
                        </div> 
                    </div>
                    <!~~ Credit Ansonia details ~~>
                    <div *ngIf="showDetailedView === 'creditAnsonia'">
                        <div class="table-container">
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 33.33%;">Last updated</th>
                                    <th class="header" style="width: 33.33%;">Risk score</th>
                                    <th class="header" style="width: 33.33%;">Rating</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaLastUpdate || "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaRiskScore || "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaRating || "N/A" }}</td>
                                </tr>                                
                            </table>
                            <table class="bordered-table">
                                <tr>
                                    <th class="header" style="width: 33.33%;">Average days to pay</th>
                                    <th class="header" style="width: 33.33%;">Average balance</th>
                                    <th class="header" style="width: 33.33%;">High balance</th>
                                </tr>                               
                                <tr class="table-row">
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaAvgDaysToPay || "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaAvgBalance ? formatCurrency(debtorDetails?.AnsoniaAvgBalance) : "N/A" }}</td>
                                    <td class="cell" style="width: 33.33%;">{{ debtorDetails?.AnsoniaHighBalance ? formatCurrency(debtorDetails?.AnsoniaHighBalance) : "N/A" }}</td>
                                </tr>                                
                            </table>
                        </div> 
                    </div>
                </mat-card>
            </mat-grid-tile>
        </mat-grid-list>-->



        <!-- trend analysis table and chart 1 -->
        <mat-grid-list cols="1" rowHeight="auto">
            <mat-card appearance="raised" class="mat-card-trend-table">
                <div class="col-md-12">
                    <!-- <label class="form-label"><strong>Periods</strong></label>
                    <br> -->
                    <mat-accordion>
                        <mat-expansion-panel (opened)="table1OpenState.set(true)" (closed)="table1OpenState.set(false)"  style="background-color: rgb(255, 255, 255);">
                            <mat-expansion-panel-header>
                            <mat-panel-title> Trend Analysis for {{ticketData.Debtor}} - {{ticketData.Client}} </mat-panel-title>
                            <mat-panel-description>
                                Click to {{!table1OpenState() ? 'open' : 'closed'}} table
                            </mat-panel-description>
                            </mat-expansion-panel-header>

                            <mat-form-field class="periods-selection">
                            <mat-label>Periods</mat-label>
                            <select [(ngModel)]="trendPeriodChar" (change)="onTrendPeriodChange($event)" matNativeControl required>
                                <option value="M">Months</option>
                                <option value="Q">Quarters</option>
                                <option value="Y">Years</option>
                            </select>
                            </mat-form-field>

                            <table mat-table [dataSource]="ticketingTrendDataVertical" matTableExporter #exporter="matTableExporter"
                                class="mat-elevation-z8 trend-table">
                                @for (it of displayedColumnsVertical; track it) {
                                <ng-container matColumnDef={{it}}>
                                    <th mat-header-cell *matHeaderCellDef> {{it}} </th>
                                    <td mat-cell *matCellDef="let element"> {{element[it]}} </td>
                                </ng-container>
                                }
                                <tr mat-header-row *matHeaderRowDef="displayedColumnsVertical"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumnsVertical;"></tr>
                            </table>
                    
                        </mat-expansion-panel>
                    </mat-accordion>

                    <mat-accordion>
                        <mat-expansion-panel (opened)="panel1OpenState.set(true)" (closed)="panel1OpenState.set(false)"  style="background-color: rgb(255, 255, 255);">
                            <mat-expansion-panel-header>
                            <mat-panel-title> Trend Chart </mat-panel-title>
                            <mat-panel-description>
                                Click to {{!panel1OpenState() ? 'open' : 'closed'}} chart
                            </mat-panel-description>
                            </mat-expansion-panel-header>
                                <div class="col-md-12">
                                    <select class="form-column-selection" [(ngModel)]="trendColumn" (change)="onTrendColumnChange()">
                                    <option value="Purchases">Purchases</option>
                                    <option value="PurchasesAvg">Average</option>
                                    <option value="PurchasesNo">Invoices</option>
                                    <option value="PaiTodZero">Paid to zero</option>
                                    <option value="Recoursed">Recoursed</option>
                                    <option value="AvgWeightedDays">Average Weighted Days</option>
                                    </select>
                                    
                                    <div style="width: 100%; height: 500px;">
                                    <canvas #trendBarChart></canvas>
                                    </div>
                                </div>
                        </mat-expansion-panel>
                    </mat-accordion>

                </div>
            </mat-card>
        </mat-grid-list>
        <!-- trend analysis table and chart 2 -->
        <mat-grid-list cols="1" rowHeight="auto">
            <mat-card appearance="raised" class="mat-card-trend-table">
                <div class="col-md-12">

                    <mat-accordion>
                        <mat-expansion-panel (opened)="panel2OpenState.set(true)" (closed)="panel2OpenState.set(false)"  style="background-color: rgb(255, 255, 255);">
                            <mat-expansion-panel-header>
                            <mat-panel-title> Trend Analysis for {{ticketData.Debtor}} - All Clients </mat-panel-title>
                            <mat-panel-description>
                                Click to {{!panel2OpenState() ? 'open' : 'closed'}} table
                            </mat-panel-description>
                            </mat-expansion-panel-header>

                            <mat-form-field class="periods-selection">
                            <mat-label>Periods</mat-label>
                            <select [(ngModel)]="trendPeriodChar2" (change)="onTrendPeriod2Change($event)" matNativeControl required>
                                <option value="M">Months</option>
                                <option value="Q">Quarters</option>
                                <option value="Y">Years</option>
                            </select>
                            </mat-form-field>

                            <table mat-table [dataSource]="ticketingTrendDataVertical2" matTableExporter #exporter="matTableExporter"
                                class="mat-elevation-z8 trend-table">
                                @for (it of displayedColumnsVertical2; track it) {
                                <ng-container matColumnDef={{it}}>
                                    <th mat-header-cell *matHeaderCellDef> {{it}} </th>
                                    <td mat-cell *matCellDef="let element"> {{element[it]}} </td>
                                </ng-container>
                                }
                                <tr mat-header-row *matHeaderRowDef="displayedColumnsVertical2"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumnsVertical2;"></tr>
                            </table>
                    
                        </mat-expansion-panel>
                    </mat-accordion>

                    <mat-accordion>
                        <mat-expansion-panel (opened)="panel2OpenState.set(true)" (closed)="panel2OpenState.set(false)"  style="background-color: rgb(255, 255, 255);">
                            <mat-expansion-panel-header>
                            <mat-panel-title> Trend Chart </mat-panel-title>
                            <mat-panel-description>
                                Click to {{!panel2OpenState() ? 'open' : 'closed'}} chart
                            </mat-panel-description>
                            </mat-expansion-panel-header>
                                <div class="col-md-12">
                                    <select class="form-column-selection" [(ngModel)]="trendColumn2" (change)="onTrendColumnChange2()">
                                    <option value="Purchases">Purchases</option>
                                    <option value="PurchasesAvg">Average</option>
                                    <option value="PurchasesNo">Invoices</option>
                                    <option value="PaiTodZero">Paid to zero</option>
                                    <option value="Recoursed">Recoursed</option>
                                    <option value="AvgWeightedDays">Average Weighted Days</option>
                                    </select>
                                    
                                    <div style="width: 100%; height: 500px;">
                                    <canvas #trendBarChart2></canvas>
                                    </div>
                                </div>
                        </mat-expansion-panel>
                    </mat-accordion>

                </div>
            </mat-card>
        </mat-grid-list>



        <!-- credit request # card -->
        <mat-card appearance="raised" class="card-container-v2">
            <div class="card-base">
                <p class="text2">Credit Request #</p>
                <p class="title2 word-wrap">{{ticketData.RequestNo}} on {{ticketData.RequestDate | date:'MM/dd/yyyy h:mm a'}} by {{ticketData.RequestUser}}</p>
                
                <div class="debtor-client-row">
                    <div class="debtor-section">
                        <p class="text2">Debtor Name</p>
                        <p class="title2 word-wrap">{{ticketData.Debtor}}</p>
                    </div>
                    
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    
                    <div class="client-section">
                        <p class="text2">Client Name</p>
                        <p class="title2 word-wrap">{{ticketData.Client}}</p>
                    </div>
                </div>
            </div>
        </mat-card>

        <!-- debtor profiles card -->
        <mat-card appearance="raised" class="card-container-v2">
            <div class="card-base">
                <p class="title2">Debtor Profile</p>
                <div class="flex-row">
                    <div class="flex-column" style="flex: 3;">
                        <p class="text2">Debtor Name</p>
                        <p class="title1 word-wrap">{{ticketData.Debtor}}</p>
                    </div>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Established date</p>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <p class="title1 word-wrap">{{'2018-06-29 11:26:38.000' | date:'yyyy-MM-dd'}}</p>
                            <p class="text1">{{calculateGapDays('2018-06-29 11:26:38.000')}}</p>
                        </div>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-column">
                        <p class="text2">Debtor ID</p>
                        <p class="title1">{{debtorDetails?.DebtorKey || 'N/A'}}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column">
                        <p class="text2">MC#</p>
                        <p class="title1">{{debtorDetails?.MotorCarrNo || 'N/A'}}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column">
                        <p class="text2">DUNS</p>
                        <p class="title1">{{debtorDetails?.DbDunsNo || 'N/A'}}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column">
                        <p class="text2"># of Client Relationship</p>
                        <p class="title1">{{'N/A'}}</p>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-column" style="flex: 3;">
                        <p class="text2">Address</p>
                        <p class="title3">{{debtorDetails?.Addr1 || ''}}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Edit</p>
                        <p class="title3"><mat-icon color="primary" (click)="editDebtor(debtorDetails)" class="input-icon ms-2 icon-hover-effect">edit</mat-icon></p>
                    </div>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Documents</p>
                        <p class="title3"> <i class="fa fa-file" [style.color]="'#3a8ada'"></i></p>
                    </div>
                    <div class="flex-column" style="flex: 1;">
                        <p class="text2">Audit</p>
                        <p class="title3"> <i class="fa-solid fa-list-check" [style.color]="'#3a8ada'"></i></p>
                    </div>
                </div>

                <div class="flex-row">
                    <div class="flex-column">
                        <p class="text2">Warning</p>
                        <p class="text2">{{debtorDetails?.Warning || ''}}</p>
                    </div>
                    <mat-divider vertical class="vertical-divider"></mat-divider>
                    <div class="flex-column">
                        <p class="text2">Instruction</p>
                        <p class="text2">{{debtorDetails?.Notes || ''}}</p>
                    </div>
                </div>
            </div>
        </mat-card>

        <div class="equal-height-row">
            <!-- Credit profiles card -->
            <div class="equal-height-column" style="flex: 3;">
                <mat-card appearance="raised" class="card-container-v2">
                    <div class="card-base">
                        <p class="title2">Credit Profile</p>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Overall credit limit</p>
                                <p class="title1">{{'500,000'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Credit utilization %</p>
                                <p class="title1">{{'80%'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Internal Rating</p>
                                <p class="title1" style="color: green;">{{'A'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">AIG Coverage</p>
                                <p class="title1">{{'N/A'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Net Terms</p>
                                <p class="title1">{{'N/A'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Risk Trend</p>
                                <p class="title1">{{'TBD'}}</p>
                            </div>
                        </div>

                        <p class="title2">Ansonia Rating</p>
                        <div class="flex-row">
                            <div class="flex-column">
                                <p class="text2">Risk Score</p>
                                <p class="title1" style="color: green;">{{'80'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Rating</p>
                                <p class="title1">{{'43K-54'}}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Avg days to pay</p>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <p class="title1" style="color: green;">{{'28'}}</p>
                                    <p class="text3">Days</p>
                                </div>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">Avg Balance</p>
                                <p class="title1">{{ debtorDetails?.AnsoniaAvgBalance ? formatCurrency(debtorDetails?.AnsoniaAvgBalance) : "N/A" }}</p>
                            </div>
                            <mat-divider vertical class="vertical-divider"></mat-divider>
                            <div class="flex-column">
                                <p class="text2">High Balance</p>
                                <p class="title1">{{ debtorDetails?.AnsoniaHighBalance ? formatCurrency(debtorDetails?.AnsoniaHighBalance) : "N/A" }}</p>
                            </div>
                        </div>
                    </div> 
                </mat-card>
            </div>
            <!-- Client relationship analsysis card -->
            <div class="equal-height-column" style="flex: 1;">
                <mat-card appearance="raised" class="card-container-v2">
                    <div class="card-base">
                        <p class="title2">Client relationship analsysis</p>
                    </div>
                </mat-card>
            </div>
        </div>


    </div>
</mat-drawer-container>